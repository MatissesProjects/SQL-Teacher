<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Buddy (Local)</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SQL.js for the database engine -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.13.0/sql-wasm.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style type="text/tailwindcss">
        @layer components {
            /* Scrollbar */
            ::-webkit-scrollbar { @apply w-2 h-2; }
            ::-webkit-scrollbar-track { @apply bg-slate-800; }
            ::-webkit-scrollbar-thumb { @apply bg-slate-600 rounded-full; }
            ::-webkit-scrollbar-thumb:hover { @apply bg-slate-500; }

            /* Layout Components */
            .sidebar { @apply fixed inset-y-0 left-0 z-50 w-3 hover:w-64 bg-slate-900 border-r border-slate-700 flex flex-col transition-all duration-300 ease-in-out shadow-2xl overflow-hidden; }
            .sidebar:hover { @apply border-slate-600; }

            .sidebar-header { @apply p-4 border-b border-slate-700 flex justify-between items-center bg-slate-950 min-w-[16rem]; }
            .sidebar-label { @apply px-4 py-3 text-xs font-semibold text-slate-500 uppercase tracking-wider flex items-center gap-2; }
            .sidebar-list { @apply space-y-1 px-2 pb-4; }
            .sidebar-item { @apply w-full text-left text-sm px-3 py-1 text-slate-400 hover:text-blue-300 hover:bg-slate-800 rounded transition-colors truncate flex items-center gap-2; }
            .sidebar-footer { @apply h-64 border-t border-slate-700 bg-slate-900 flex flex-col min-w-[16rem]; }
            
            /* Inner Container for Sidebar Content to prevent squashing */
            .sidebar-content-wrapper { @apply min-w-[16rem] h-full flex flex-col; }

            .main-content { @apply w-full h-full flex flex-col bg-[#1e1e1e] pl-3; }
            .toolbar { @apply h-14 border-b border-slate-800 bg-slate-900 flex items-center px-4 justify-between flex-shrink-0; }
            
            /* Buttons */
            .btn-icon { @apply p-1 hover:bg-slate-800 rounded transition-colors text-slate-400; }
            .btn-secondary { @apply flex items-center gap-2 px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded text-xs font-medium transition-colors; }
            .btn-primary { @apply flex items-center gap-2 px-4 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded text-sm font-medium transition-colors shadow-sm; }
            .btn-accent { @apply text-xs flex items-center gap-1.5 px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-500 transition-all font-medium border border-blue-500 shadow-sm shadow-blue-900/20; }
            .btn-outline { @apply text-xs flex items-center gap-1.5 px-3 py-1.5 rounded border border-slate-600 text-slate-400 hover:bg-slate-700 hover:text-white transition-all; }

            /* Utilities */
            .code-font { font-family: 'Menlo', 'Monaco', 'Courier New', monospace; }
            .bg-workspace { @apply bg-[#1e1e1e]; }
            .bg-dark-panel { @apply bg-[#0d0d0d]; }
            .code-highlight { @apply font-mono text-green-400 font-bold; }
            
            /* Results Table */
            .results-table { @apply w-full text-left text-sm border-collapse; }
            .results-thead { @apply bg-slate-100 text-slate-700 sticky top-0; }
            .results-th { @apply p-3 border-b font-bold text-slate-900 text-xs whitespace-nowrap border-r border-slate-200 last:border-r-0; }
            .results-tr { @apply hover:bg-slate-50 border-b border-slate-100 last:border-0; }
            .results-td { @apply p-3 border-r border-slate-100 last:border-r-0 font-mono text-xs text-slate-900 whitespace-nowrap; }

            /* Modals */
            .modal-overlay { @apply fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 backdrop-blur-sm; }
            .modal-container { @apply bg-slate-900 border border-slate-700 rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col; }
            
            /* Resizer */
            .resizer { @apply w-full h-1.5 bg-slate-800 hover:bg-blue-500 cursor-row-resize transition-colors flex justify-center items-center; }
            .resizer::after { content: ""; @apply w-8 h-0.5 bg-slate-600 rounded; }
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-300 h-screen flex overflow-hidden font-sans">

    <!-- Sidebar -->
    <div id="main-sidebar" class="sidebar group">
        <div class="sidebar-content-wrapper">
            <!-- Header -->
            <div class="sidebar-header">
                <h2 class="font-bold text-white flex items-center gap-2">
                    <i data-lucide="database" class="w-5 h-5 text-blue-400"></i>
                    SQL Buddy
                </h2>
                <div class="flex gap-1">
                    <button onclick="exportProgress()" class="btn-icon" title="Export Progress">
                        <i data-lucide="upload" class="w-5 h-5"></i>
                    </button>
                    <button onclick="document.getElementById('file-input').click()" class="btn-icon" title="Import Curriculum">
                        <i data-lucide="download" class="w-5 h-5"></i>
                    </button>
                    <input type="file" id="file-input" class="hidden" accept=".json" onchange="importCurriculum(this)">
                    <button onclick="createNewSnippet()" class="btn-icon text-blue-400" title="New Snippet">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- Lists -->
            <div class="flex-1 overflow-y-auto min-h-0" id="sidebar-content">
                <!-- Curriculum Section -->
                <div class="sidebar-label">
                    <i data-lucide="book-open" class="w-3 h-3"></i> Curriculum
                </div>
                <div id="curriculum-list" class="sidebar-list">
                    <!-- Lessons injected by JS -->
                </div>

                <!-- Saved Snippets Section -->
                <div class="sidebar-label border-t border-slate-800 pt-4">
                    <i data-lucide="save" class="w-3 h-3"></i> Your Saved Snippets
                </div>
                <div id="snippet-list" class="sidebar-list">
                    <!-- User snippets injected by JS -->
                </div>
            </div>

            <!-- Schema Footer -->
            <div class="sidebar-footer" id="schema-footer" style="height: 250px;">
                <div id="schema-resizer" class="resizer"></div>
                <div class="sidebar-label bg-slate-950">
                    <i data-lucide="columns" class="w-3 h-3"></i> Schema
                </div>
                <div class="flex-1 overflow-y-auto p-2 space-y-2" id="schema-container">
                    <!-- Schema injected by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        
        <!-- Toolbar -->
        <div class="toolbar">
            <div class="flex items-center gap-3 flex-1">
                <div id="sidebar-trigger" class="text-slate-600 hover:text-slate-400 transition-colors cursor-pointer" title="Hover over the left edge to expand menu">
                    <i data-lucide="menu" class="w-5 h-5"></i>
                </div>
                <div class="bg-blue-500/10 text-blue-400 p-1.5 rounded">
                    <i data-lucide="terminal" class="w-4 h-4"></i>
                </div>
                <input type="text" id="snippet-title" class="bg-transparent text-white font-semibold focus:outline-none focus:bg-slate-800 px-2 py-1 rounded w-full max-w-md" placeholder="Untitled Query">
                <span id="save-status" class="text-xs text-slate-500 hidden">Saved locally</span>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="saveCurrentAsSnippet()" class="btn-secondary" title="Save as Snippet">
                    <i data-lucide="save" class="w-3.5 h-3.5"></i>
                </button>
                <button onclick="toggleCheatSheet()" class="btn-secondary" title="SQL Reference">
                    <i data-lucide="help-circle" class="w-3.5 h-3.5"></i>
                </button>
                <button onclick="resetDatabase()" class="btn-secondary">
                    <i data-lucide="rotate-ccw" class="w-3.5 h-3.5"></i> Reset DB
                </button>
                <button onclick="runQuery()" class="btn-primary">
                    <i data-lucide="play" class="w-3.5 h-3.5 fill-current"></i> Run
                </button>
            </div>
        </div>

        <!-- Task Banner (Hidden by default) -->
        <div id="task-banner" class="hidden bg-slate-800 border-b border-slate-700 p-4">
            <div class="flex items-start gap-3">
                <div class="bg-blue-500/20 p-2 rounded text-blue-400">
                    <i data-lucide="graduation-cap" class="w-5 h-5"></i>
                </div>
                <div class="flex-1">
                    <div id="explanation-box" class="mb-3 border-b border-slate-700/50 pb-3 hidden">
                        <h4 class="text-blue-400 text-xs font-bold uppercase tracking-wider mb-1">Learn</h4>
                        <p id="explanation-text" class="text-slate-300 text-sm leading-relaxed"></p>
                    </div>
                    
                    <h4 class="text-white text-xs font-bold uppercase tracking-wider mb-1">Challenge</h4>
                    <p id="task-text" class="text-slate-200 text-sm"></p>
                </div>
                <div class="flex flex-col gap-2">
                    <div class="flex gap-2">
                        <button onclick="loadPreviousLesson()" class="btn-outline" title="Previous Lesson">
                            <i data-lucide="arrow-left" class="w-3.5 h-3.5"></i>
                        </button>
                        <button onclick="resetLesson()" class="btn-outline" title="Restart Lesson">
                            <i data-lucide="rotate-ccw" class="w-3.5 h-3.5"></i>
                        </button>
                        <button onclick="checkAnswer()" class="btn-accent" id="btn-check">
                            <i data-lucide="check-circle-2" class="w-3.5 h-3.5"></i> Check
                        </button>
                        <button onclick="loadNextLesson()" class="hidden btn-primary bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1.5 rounded flex items-center gap-1.5 transition-colors shadow-lg shadow-green-900/20" id="btn-next">
                            Next <i data-lucide="arrow-right" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>
                    <button onclick="toggleSolution()" class="btn-outline w-full justify-center">
                        <i data-lucide="eye" class="w-3.5 h-3.5"></i> <span id="solution-btn-text">Solution</span>
                    </button>
                </div>
            </div>
            <div id="solution-box" class="hidden mt-3 bg-dark-panel border border-slate-600 rounded p-3">
                <div class="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1">Solution:</div>
                <code id="solution-code" class="code-font text-green-400 text-sm whitespace-pre-wrap"></code>
            </div>
        </div>

        <!-- Workspace Split -->
        <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
            <!-- Editor -->
            <div class="flex-1 h-1/2 lg:h-full lg:w-1/2 border-b lg:border-b-0 lg:border-r border-slate-800 flex flex-col relative">
                <textarea id="sql-editor" class="flex-1 w-full bg-workspace text-slate-200 p-4 code-font text-sm resize-none focus:outline-none leading-relaxed" spellcheck="false" placeholder="SELECT * FROM users..."></textarea>
            </div>

            <!-- Results -->
            <div class="flex-1 h-1/2 lg:h-full lg:w-1/2 bg-white flex flex-col relative overflow-hidden">
                <!-- Result Tabs/Header -->
                <div class="bg-slate-50 border-b border-slate-200 p-2 flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-500 uppercase px-2">Results</span>
                    <span id="row-count" class="text-xs text-slate-400">0 rows</span>
                </div>
                
                <!-- Table Container -->
                <div id="result-container" class="flex-1 overflow-auto">
                    <div class="flex flex-col items-center justify-center h-full text-slate-400">
                        <i data-lucide="table" class="w-12 h-12 mb-4 opacity-20"></i>
                        <p>Run a query to see results</p>
                    </div>
                </div>

                <!-- Error Container -->
                <div id="error-container" class="hidden absolute inset-0 bg-white p-6">
                    <div class="bg-red-50 text-red-600 p-4 rounded border border-red-200 font-mono text-sm">
                        <strong class="block mb-2">Error:</strong>
                        <span id="error-message"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Table Inspector Modal -->
    <div id="table-inspector-modal" class="modal-overlay hidden">
        <div class="modal-container max-w-2xl">
            <div class="sidebar-header rounded-t-lg">
                <h3 class="text-white font-bold flex items-center gap-2">
                    <i data-lucide="table" class="w-5 h-5 text-emerald-400"></i>
                    <span id="inspector-title">Table Details</span>
                </h3>
                <button onclick="document.getElementById('table-inspector-modal').classList.add('hidden')" class="text-slate-400 hover:text-white transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6">
                <!-- Definition -->
                <div>
                    <h4 class="text-blue-400 font-bold uppercase text-xs tracking-wider mb-2">Definition</h4>
                    <div class="bg-slate-950 p-3 rounded border border-slate-700 overflow-x-auto">
                        <code id="inspector-ddl" class="code-font text-sm text-green-400 whitespace-pre-wrap"></code>
                    </div>
                </div>
                <!-- Preview -->
                <div>
                    <h4 class="text-purple-400 font-bold uppercase text-xs tracking-wider mb-2">Data Preview (Top 3 Rows)</h4>
                    <div id="inspector-preview" class="border border-slate-700 rounded overflow-hidden bg-slate-100">
                        <!-- Table injected here -->
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-slate-700 bg-slate-950 rounded-b-lg text-center">
                 <button onclick="document.getElementById('table-inspector-modal').classList.add('hidden')" class="px-6 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded text-sm transition-colors">Close</button>
            </div>
        </div>
    </div>

    <!-- Cheat Sheet Modal -->
    <div id="cheat-sheet-modal" class="modal-overlay hidden">
        <div class="modal-container">
            <div class="sidebar-header rounded-t-lg">
                <h3 class="text-white font-bold flex items-center gap-2">
                    <i data-lucide="book" class="w-5 h-5 text-blue-400"></i>
                    SQL Cheat Sheet
                </h3>
                <button onclick="toggleCheatSheet()" class="text-slate-400 hover:text-white transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                <!-- Select & Filter -->
                <div class="space-y-3">
                    <h4 class="text-blue-400 font-bold uppercase text-xs tracking-wider border-b border-blue-500/20 pb-1">Retrieving Data</h4>
                    <div class="space-y-1">
                        <div class="code-highlight">SELECT * FROM table;</div>
                        <div class="text-slate-500 text-xs">Get all columns from a table.</div>
                    </div>
                    <div class="space-y-1">
                        <div class="code-highlight">SELECT col1, col2 FROM table;</div>
                        <div class="text-slate-500 text-xs">Get specific columns.</div>
                    </div>
                    <div class="space-y-1">
                        <div class="code-highlight">SELECT DISTINCT col FROM table;</div>
                        <div class="text-slate-500 text-xs">Get unique values only.</div>
                    </div>
                     <div class="space-y-1">
                        <div class="code-highlight">... WHERE col > 5;</div>
                        <div class="text-slate-500 text-xs">Filter rows by condition.</div>
                    </div>
                    <div class="space-y-1">
                        <div class="code-highlight">... WHERE name LIKE '%A%';</div>
                        <div class="text-slate-500 text-xs">Search for pattern (contains 'A').</div>
                    </div>
                    <div class="space-y-1">
                        <div class="code-highlight">... ORDER BY col ASC/DESC;</div>
                        <div class="text-slate-500 text-xs">Sort results.</div>
                    </div>
                     <div class="space-y-1">
                        <div class="code-highlight">... LIMIT 5;</div>
                        <div class="text-slate-500 text-xs">Take only first 5 rows.</div>
                    </div>
                </div>

                <!-- Aggregation -->
                <div class="space-y-3">
                    <h4 class="text-purple-400 font-bold uppercase text-xs tracking-wider border-b border-purple-500/20 pb-1">Aggregation</h4>
                     <div class="space-y-1">
                        <div class="code-highlight">COUNT(*)</div>
                        <div class="text-slate-500 text-xs">Count total rows.</div>
                    </div>
                    <div class="space-y-1">
                        <div class="code-highlight">SUM(col), AVG(col)</div>
                        <div class="text-slate-500 text-xs">Sum or Average of a column.</div>
                    </div>
                    <div class="space-y-1">
                        <div class="code-highlight">MIN(col), MAX(col)</div>
                        <div class="text-slate-500 text-xs">Smallest or Largest value.</div>
                    </div>
                     <div class="space-y-1">
                        <div class="code-highlight">GROUP BY col</div>
                        <div class="text-slate-500 text-xs">Group data for aggregation.</div>
                    </div>
                </div>

                <!-- Joins -->
                <div class="space-y-3">
                    <h4 class="text-orange-400 font-bold uppercase text-xs tracking-wider border-b border-orange-500/20 pb-1">Joins</h4>
                    <div class="space-y-1">
                        <div class="code-highlight">JOIN other ON t1.id = t2.ref_id</div>
                        <div class="text-slate-500 text-xs">Inner join (only matches).</div>
                    </div>
                    <div class="space-y-1">
                        <div class="code-highlight">LEFT JOIN other ON ...</div>
                        <div class="text-slate-500 text-xs">Keep all left rows, match right if exists.</div>
                    </div>
                </div>

                <!-- Modification -->
                <div class="space-y-3">
                    <h4 class="text-red-400 font-bold uppercase text-xs tracking-wider border-b border-red-500/20 pb-1">Modification</h4>
                    <div class="space-y-1">
                        <div class="code-highlight">INSERT INTO table (c1, c2) VALUES (v1, v2);</div>
                        <div class="text-slate-500 text-xs">Add new data.</div>
                    </div>
                    <div class="space-y-1">
                        <div class="code-highlight">UPDATE table SET c1 = v1 WHERE ...;</div>
                        <div class="text-slate-500 text-xs">Modify existing data.</div>
                    </div>
                    <div class="space-y-1">
                        <div class="code-highlight">DELETE FROM table WHERE ...;</div>
                        <div class="text-slate-500 text-xs">Remove data.</div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-slate-700 bg-slate-950 rounded-b-lg text-center">
                 <button onclick="toggleCheatSheet()" class="px-6 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded text-sm transition-colors">Close</button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- DATA CONSTANTS ---
        let CURRICULUM = [
            {
                category: "0. Foundations",
                lessons: [
                    { 
                        title: "Select All", 
                        sql: "SELECT * FROM users", 
                        task: "Retrieve all columns from the 'users' table.", 
                        solution: "SELECT * FROM users",
                        explanation: "The <code>SELECT</code> statement is the foundation of SQL. <br>• <code>*</code> is a wildcard that means 'all columns'. <br>• <code>FROM users</code> tells the database which table to search." 
                    },
                    { 
                        title: "Limiting Results", 
                        sql: "SELECT * FROM users LIMIT 2", 
                        task: "Get all columns for the first 2 users.", 
                        solution: "SELECT * FROM users LIMIT 2",
                        reqKeywords: ["LIMIT"],
                        explanation: "When a table contains thousands of rows, you often just want to peek at the data. <br>Use <code>LIMIT n</code> to restrict the result to <code>n</code> rows."
                    },
                    { 
                        title: "Unique Values", 
                        sql: "SELECT DISTINCT role FROM users", 
                        task: "Find all unique values in the 'role' column.", 
                        solution: "SELECT DISTINCT role FROM users",
                        reqKeywords: ["DISTINCT"],
                        explanation: "The <code>DISTINCT</code> keyword removes duplicate rows from the result. <br>This is useful for finding all available categories, roles, or types."
                    }
                ]
            },
            {
                category: "1. Basics",
                lessons: [
                    { 
                        title: "Specific Columns", 
                        sql: "SELECT name, email FROM users", 
                        task: "Show only the 'name' and 'email' columns for all users.", 
                        solution: "SELECT name, email FROM users",
                        explanation: "Instead of fetching everything with <code>*</code>, you can list specific column names separated by commas. This is better for performance and clarity."
                    },
                    { 
                        title: "Filtering with WHERE", 
                        sql: "SELECT * FROM products WHERE price > 20", 
                        task: "Find all columns for products that cost more than $20.", 
                        solution: "SELECT * FROM products WHERE price > 20",
                        reqKeywords: ["WHERE"],
                        explanation: "The <code>WHERE</code> clause filters rows based on a specific condition. Only rows where the condition is true are returned."
                    },
                    { 
                        title: "String Matching", 
                        sql: "SELECT * FROM users WHERE email LIKE '%gmail%'", 
                        task: "Find all columns for users with 'gmail' in their email.", 
                        solution: "SELECT * FROM users WHERE email LIKE '%gmail%'",
                        reqKeywords: ["LIKE"],
                        explanation: "The <code>LIKE</code> operator is used for pattern matching. <br><code>%</code> is a wildcard that matches any sequence of characters (e.g. '%gmail%' matches any email containing 'gmail')."
                    }
                ]
            },
            {
                category: "2. Keys & Relationships",
                lessons: [
                    { 
                        title: "Primary Keys (PK)", 
                        sql: "SELECT id FROM users WHERE name = 'Alice Johnson'", 
                        task: "Find the 'id' for the user named 'Alice Johnson'.", 
                        solution: "SELECT id FROM users WHERE name = 'Alice Johnson'",
                        reqKeywords: ["WHERE"],
                        explanation: "A **Primary Key** is a unique identifier for a specific row. It ensures that every record can be distinctly identified (like a user ID)."
                    },
                    { 
                        title: "Foreign Keys (FK)", 
                        sql: "SELECT * FROM orders WHERE user_id = 1", 
                        task: "Find all columns for orders placed by User ID 1.", 
                        solution: "SELECT * FROM orders WHERE user_id = 1",
                        reqKeywords: ["WHERE"],
                        explanation: "A **Foreign Key** is a column that links to the Primary Key of another table. This link creates a relationship between the data (e.g. associating an order with a user)."
                    },
                    { 
                        title: "Joining via Keys", 
                        sql: "SELECT users.name, orders.id as order_id FROM users JOIN orders ON users.id = orders.user_id", 
                        task: "Join Users and Orders. Select the user's 'name' and the order's 'id' (aliased as 'order_id').", 
                        solution: "SELECT users.name, orders.id as order_id FROM users JOIN orders ON users.id = orders.user_id",
                        reqKeywords: ["JOIN"],
                        explanation: "To combine data from two tables, you use <code>JOIN</code>. You must specify how they match using <code>ON</code> (usually matching the Foreign Key to the Primary Key)."
                    }
                ]
            },
            {
                category: "3. Aggregation",
                lessons: [
                    { 
                        title: "Counting Rows", 
                        sql: "SELECT COUNT(*) FROM orders", 
                        task: "Count the total number of orders placed.", 
                        solution: "SELECT COUNT(*) FROM orders",
                        reqKeywords: ["COUNT"],
                        explanation: "<code>COUNT(*)</code> returns the total number of rows that match your criteria. It is one of the most common ways to get quick statistics."
                    },
                    { 
                        title: "Grouping Data", 
                        sql: "SELECT category, COUNT(*) as count FROM products GROUP BY category", 
                        task: "Select 'category' and a count of products (aliased as 'count') for each category.", 
                        solution: "SELECT category, COUNT(*) as count FROM products GROUP BY category",
                        reqKeywords: ["GROUP BY"],
                        explanation: "<code>GROUP BY</code> groups rows that have the same values into summary rows. It is often used with aggregate functions like `COUNT`, `SUM`, or `AVG`."
                    },
                    { 
                        title: "Average Calculation", 
                        sql: "SELECT AVG(price) as average_price FROM products", 
                        task: "Calculate the average price of all products and alias it as 'average_price'.", 
                        solution: "SELECT AVG(price) as average_price FROM products",
                        reqKeywords: ["AVG"],
                        explanation: "SQL has built-in math functions. <code>AVG()</code> calculates the average value of a numeric column. Others include <code>SUM()</code>, <code>MIN()</code>, and <code>MAX()</code>."
                    }
                ]
            },
            {
                category: "4. Joins (Intermediate)",
                lessons: [
                    { 
                        title: "Inner Join", 
                        sql: "SELECT users.name, orders.status \nFROM users \nJOIN orders ON users.id = orders.user_id", 
                        task: "Show the user 'name' and order 'status' for all orders.", 
                        solution: "SELECT users.name, orders.status \nFROM users \nJOIN orders ON users.id = orders.user_id",
                        reqKeywords: ["JOIN"],
                        explanation: "An <code>INNER JOIN</code> (or just <code>JOIN</code>) returns only the rows where there is a match in **both** tables. Unmatched rows are excluded."
                    },
                    { 
                        title: "Multiple Joins", 
                        sql: "SELECT users.name, products.name, products.category \nFROM orders \nJOIN users ON orders.user_id = users.id \nJOIN products ON orders.product_id = products.id \nWHERE products.category = 'Electronics'", 
                        task: "Find who ordered 'Electronics'. Select user 'name', product 'name', and product 'category'.", 
                        solution: "SELECT users.name, products.name, products.category \nFROM orders \nJOIN users ON orders.user_id = users.id \nJOIN products ON orders.product_id = products.id \nWHERE products.category = 'Electronics'",
                        reqKeywords: ["JOIN"],
                        explanation: "You can chain multiple <code>JOIN</code> statements to connect several tables together in a single query. Here we link Orders to both Users and Products."
                    },
                    { 
                        title: "Left Join", 
                        sql: "SELECT users.name, orders.id as order_id \nFROM users \nLEFT JOIN orders ON users.id = orders.user_id", 
                        task: "Show all users, even those who haven't ordered anything. Select user 'name' and order 'id' (aliased as 'order_id').", 
                        solution: "SELECT users.name, orders.id as order_id \nFROM users \nLEFT JOIN orders ON users.id = orders.user_id",
                        reqKeywords: ["LEFT JOIN"],
                        explanation: "A <code>LEFT JOIN</code> returns **all** rows from the left table (Users), and the matched rows from the right table (Orders). If there is no match, the result is NULL."
                    }
                ]
            },
            {
                category: "5. Data Modification",
                lessons: [
                    { 
                        title: "Insert Data", 
                        sql: "INSERT INTO users (id, name, email, role, joined) \nVALUES (6, 'Frank', 'frank@test.com', 'user', '2023-06-01');\nSELECT * FROM users;", 
                        task: "Add a new user named 'Frank'. Then select all columns from users to verify.", 
                        solution: "INSERT INTO users (id, name, email, role, joined) VALUES (6, 'Frank', 'frank@test.com', 'user', '2023-06-01');",
                        reqKeywords: ["INSERT"],
                        explanation: "<code>INSERT INTO</code> adds new records to a table. You typically specify the table name, the column names, and the `VALUES` to insert."
                    },
                    { 
                        title: "Update Data", 
                        sql: "UPDATE users SET role = 'superadmin' WHERE name = 'Alice Johnson';\nSELECT * FROM users;", 
                        task: "Change Alice's role to 'superadmin'. Then select all columns from users to verify.", 
                        solution: "UPDATE users SET role = 'superadmin' WHERE name = 'Alice Johnson';",
                        reqKeywords: ["UPDATE"],
                        explanation: "<code>UPDATE</code> modifies existing records. <br>⚠️ **Important:** Always include a <code>WHERE</code> clause, or you might accidentally update every row in the table!"
                    }
                ]
            }
        ];

        let INIT_SQL = `
            CREATE TABLE users (id INTEGER PRIMARY KEY, name TEXT, email TEXT, role TEXT, joined TEXT);
            INSERT INTO users VALUES 
            (1, 'Alice Johnson', 'alice@example.com', 'admin', '2023-01-01'),
            (2, 'Bob Smith', 'bob@test.com', 'user', '2023-01-15'),
            (3, 'Charlie Brown', 'charlie@gmail.com', 'user', '2023-02-10'),
            (4, 'Diana Prince', 'diana@wonder.com', 'moderator', '2023-03-05'),
            (5, 'Evan Wright', 'evan@tech.com', 'user', '2023-03-20');

            CREATE TABLE products (id INTEGER PRIMARY KEY, name TEXT, price REAL, category TEXT, stock INTEGER);
            INSERT INTO products VALUES
            (101, 'Wireless Mouse', 29.99, 'Electronics', 50),
            (102, 'Mechanical Keyboard', 129.50, 'Electronics', 20),
            (103, 'Coffee Mug', 12.00, 'Home', 100),
            (104, 'Notebook', 5.99, 'Office', 200),
            (105, 'USB-C Cable', 15.00, 'Electronics', 75),
            (106, 'Gaming Monitor', 299.99, 'Electronics', 10);

            CREATE TABLE orders (id INTEGER PRIMARY KEY, user_id INTEGER, product_id INTEGER, amount INTEGER, status TEXT, date TEXT);
            INSERT INTO orders VALUES
            (1001, 1, 102, 1, 'shipped', '2023-05-01'),
            (1002, 2, 101, 2, 'processing', '2023-05-02'),
            (1003, 1, 105, 3, 'delivered', '2023-05-03'),
            (1004, 3, 103, 1, 'cancelled', '2023-05-04'),
            (1005, 2, 103, 4, 'shipped', '2023-05-05'),
            (1006, 4, 106, 1, 'delivered', '2023-05-06');
        `;

        let SCHEMA = {
            users: { 
                id: { type: 'INTEGER', key: 'PK' }, 
                name: { type: 'TEXT' }, 
                email: { type: 'TEXT' }, 
                role: { type: 'TEXT' }, 
                joined: { type: 'TEXT' } 
            },
            products: { 
                id: { type: 'INTEGER', key: 'PK' }, 
                name: { type: 'TEXT' }, 
                price: { type: 'REAL' }, 
                category: { type: 'TEXT' }, 
                stock: { type: 'INTEGER' } 
            },
            orders: { 
                id: { type: 'INTEGER', key: 'PK' }, 
                user_id: { type: 'INTEGER', key: 'FK' }, 
                product_id: { type: 'INTEGER', key: 'FK' }, 
                amount: { type: 'INTEGER' }, 
                status: { type: 'TEXT' }, 
                date: { type: 'TEXT' } 
            }
        };

        // --- STATE ---
        let db = null;
        let activeSnippet = { id: null, title: "", sql: "", task: null, solution: null };
        let savedSnippets = JSON.parse(localStorage.getItem('sql_buddy_snippets') || '[]');
        let completedLessons = JSON.parse(localStorage.getItem('sql_buddy_progress') || '[]');

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            await initDB();
            renderSidebar();
            initResizer();
            initSidebarInteraction();
            
            // Load first lesson if no snippets, or empty
            if (savedSnippets.length > 0) {
                loadSnippet(savedSnippets[0].id);
            } else {
                loadLesson(CURRICULUM[0].lessons[0]);
            }

            // Auto-save listener
            document.getElementById('sql-editor').addEventListener('input', (e) => {
                activeSnippet.sql = e.target.value;
                debounceSave();
            });

            // Run on Shift+Enter
            document.getElementById('sql-editor').addEventListener('keydown', (e) => {
                if (e.shiftKey && e.key === 'Enter') {
                    e.preventDefault();
                    runQuery();
                }
            });

            document.getElementById('snippet-title').addEventListener('input', (e) => {
                activeSnippet.title = e.target.value;
                debounceSave();
            });
        });

        function initResizer() {
            const resizer = document.getElementById('schema-resizer');
            const footer = document.getElementById('schema-footer');
            const sidebar = document.getElementById('main-sidebar');
            let startY, startHeight;

            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                startY = e.clientY;
                startHeight = footer.offsetHeight;
                
                // Expand sidebar if not already
                sidebar.classList.add('w-64');
                
                document.documentElement.addEventListener('mousemove', doDrag, false);
                document.documentElement.addEventListener('mouseup', stopDrag, false);
            });

            function doDrag(e) {
                const newHeight = startHeight - (e.clientY - startY);
                if (newHeight > 100 && newHeight < window.innerHeight - 200) {
                    footer.style.height = newHeight + 'px';
                }
            }

            function stopDrag() {
                document.documentElement.removeEventListener('mousemove', doDrag, false);
                document.documentElement.removeEventListener('mouseup', stopDrag, false);
                // Reset sidebar hover width behavior
                sidebar.classList.remove('w-64');
            }
        }

        function initSidebarInteraction() {
            const trigger = document.getElementById('sidebar-trigger');
            const sidebar = document.getElementById('main-sidebar');
            let closeTimer;

            function openSidebar() {
                clearTimeout(closeTimer);
                sidebar.classList.remove('w-3');
                sidebar.classList.add('w-64');
            }

            function closeSidebar() {
                // Only close if not hovered
                if (!sidebar.matches(':hover') && !trigger.matches(':hover')) {
                    sidebar.classList.remove('w-64');
                    sidebar.classList.add('w-3');
                }
            }

            // Trigger Events
            trigger.addEventListener('mouseenter', openSidebar);
            trigger.addEventListener('mouseleave', () => {
                closeTimer = setTimeout(closeSidebar, 200);
            });

            // Sidebar Events
            sidebar.addEventListener('mouseenter', () => {
                clearTimeout(closeTimer);
            });
            sidebar.addEventListener('mouseleave', () => {
                closeTimer = setTimeout(closeSidebar, 200);
            });
        }

        async function initDB() {
            const config = { locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.13.0/sql-wasm.wasm` };
            const SQL = await initSqlJs(config);
            db = new SQL.Database();
            db.run(INIT_SQL);
            console.log("DB Initialized");
        }

        function showTableDetails(table) {
            try {
                // Get DDL
                // Refactored to use db.prepare for safer parameter binding
                const stmt = db.prepare("SELECT sql FROM sqlite_master WHERE type='table' AND name=:name");
                const row = stmt.getAsObject({':name': table});
                stmt.free(); // Always free statements in sql.js
                const ddl = row.sql || "No definition found.";

                // Get Sample Data
                // Note: Table names cannot be parameterized in SQL (e.g. 'FROM ?' is invalid). 
                // We must use interpolation, but 'table' is trusted here as it comes from our hardcoded SCHEMA keys.
                const dataRes = db.exec(`SELECT * FROM ${table} LIMIT 3`);
                
                // Render
                document.getElementById('inspector-title').innerText = table;
                document.getElementById('inspector-ddl').innerText = ddl;
                
                const previewContainer = document.getElementById('inspector-preview');
                if (dataRes.length) {
                    const data = dataRes[0];
                    let html = '<table class="results-table w-full text-left text-sm border-collapse"><thead class="bg-slate-200 text-slate-800"><tr>';
                    data.columns.forEach(col => html += `<th class="p-2 border-b border-slate-300 font-bold text-xs whitespace-nowrap border-r last:border-r-0">${col}</th>`);
                    html += '</tr></thead><tbody>';
                    data.values.forEach(row => {
                        html += '<tr class="hover:bg-slate-50 border-b border-slate-200 last:border-0">';
                        row.forEach(val => html += `<td class="p-2 border-r border-slate-200 last:border-r-0 font-mono text-xs text-slate-900 whitespace-nowrap">${val}</td>`);
                        html += '</tr>';
                    });
                    html += '</tbody></table>';
                    previewContainer.innerHTML = html;
                } else {
                    previewContainer.innerHTML = '<div class="p-4 text-center text-slate-500 italic">Table is empty</div>';
                }

                // Show Modal
                document.getElementById('table-inspector-modal').classList.remove('hidden');

            } catch (err) {
                console.error(err);
                alert("Could not load table details.");
            }
        }

        function resetDatabase() {
            if(confirm("Reset database?")) {
                db.close();
                initDB();
                alert("Database reset to default.");
                runQuery();
            }
        }

        function saveCurrentAsSnippet() {
            if (activeSnippet.id) {
                // Already a saved snippet
                saveToStorage();
                // Visual feedback
                const btn = document.querySelector('button[title="Save as Snippet"]');
                const icon = btn.querySelector('i');
                const original = icon.innerHTML;
                icon.innerHTML = '<polyline points="20 6 9 17 4 12"></polyline>'; // checkmark
                setTimeout(() => { icon.innerHTML = original; lucide.createIcons(); }, 1000);
            } else {
                // Save as new
                const title = prompt("Enter a name for this snippet:", activeSnippet.title || "My Query");
                if (title) {
                    const newSnippet = {
                        id: Date.now().toString(),
                        title: title,
                        sql: document.getElementById('sql-editor').value,
                        task: null,
                        solution: null,
                        explanation: null
                    };
                    savedSnippets.push(newSnippet);
                    saveToStorage();
                    activeSnippet = newSnippet;
                    updateUI();
                    runQuery();
                }
            }
        }

        function toggleCheatSheet() {
            const modal = document.getElementById('cheat-sheet-modal');
            modal.classList.toggle('hidden');
        }

        function resetLesson() {
            if (!activeSnippet.task) return;
            
            if(confirm("Restart this lesson? This will reset your code and progress for this specific task.")) {
                 activeSnippet.sql = "";
                 updateUI();
                 
                 // Remove completion status
                 const idx = completedLessons.indexOf(activeSnippet.title);
                 if (idx !== -1) {
                     completedLessons.splice(idx, 1);
                     localStorage.setItem('sql_buddy_progress', JSON.stringify(completedLessons));
                     renderSidebar();
                 }
                 
                 // Clear results
                 document.getElementById('result-container').innerHTML = '<div class="flex flex-col items-center justify-center h-full text-slate-400"><i data-lucide="table" class="w-12 h-12 mb-4 opacity-20"></i><p>Run a query to see results</p></div>';
                 document.getElementById('row-count').innerText = "0 rows";
                 
                 // Reset Banner Colors
                 const banner = document.getElementById('task-banner');
                 banner.classList.remove('bg-green-900/20', 'border-green-500/50', 'bg-red-900/20', 'border-red-500/50');
                 banner.classList.add('border-slate-700');
            }
        }

        function exportProgress() {
            const data = {
                completedLessons: completedLessons,
                savedSnippets: savedSnippets,
                timestamp: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sql-buddy-progress-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importCurriculum(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.curriculum && !data.initSql) {
                        throw new Error("Invalid format. Expected JSON with 'curriculum' or 'initSql'.");
                    }

                    if (data.curriculum) CURRICULUM = data.curriculum;
                    if (data.schema) SCHEMA = data.schema;

                    if (data.initSql) {
                        INIT_SQL = data.initSql;
                        // Re-init DB
                        db.close();
                        initDB();
                        alert("Curriculum and Database loaded successfully!");
                    } else {
                        renderSidebar();
                        alert("Curriculum loaded successfully!");
                    }
                    
                    // Reset to first lesson of new curriculum
                    if (CURRICULUM.length > 0 && CURRICULUM[0].lessons.length > 0) {
                        loadLesson(CURRICULUM[0].lessons[0]);
                    }

                } catch (err) {
                    alert("Error parsing file: " + err.message);
                }
            };
            reader.readAsText(file);
            input.value = ''; // Reset so same file can be selected again
        }

        function checkAnswer() {
            if (!activeSnippet.task || !activeSnippet.solution) return;
            
            const userSql = document.getElementById('sql-editor').value;
            const banner = document.getElementById('task-banner');
            const resultContainer = document.getElementById('result-container');

            // 0. Keyword Check
            if (activeSnippet.reqKeywords && activeSnippet.reqKeywords.length > 0) {
                const upperSql = userSql.toUpperCase();
                const missing = activeSnippet.reqKeywords.filter(kw => !upperSql.includes(kw));
                
                if (missing.length > 0) {
                     // Failure Feedback for Keywords
                    banner.classList.remove('border-slate-700');
                    banner.classList.add('bg-orange-900/20', 'border-orange-500/50');

                    const failMsg = document.createElement('div');
                    failMsg.className = "bg-orange-100 text-orange-800 p-2 text-xs font-bold text-center border-b border-orange-200 transition-opacity duration-500";
                    failMsg.innerHTML = `⚠️ Solution must use: ${missing.join(", ")}`;
                    resultContainer.insertBefore(failMsg, resultContainer.firstChild);
                    
                    setTimeout(() => {
                        failMsg.classList.add('opacity-0');
                        setTimeout(() => failMsg.remove(), 500);
                    }, 3000);

                     setTimeout(() => {
                        banner.classList.remove('bg-orange-900/20', 'border-orange-500/50');
                        banner.classList.add('border-slate-700');
                    }, 2000);
                    
                    return; // Stop check
                }
            }
            
            try {
                // 1. Run User Query
                let userRes = [];
                try { userRes = db.exec(userSql); } catch(e) { 
                    runQuery(); // let runQuery handle/display the error
                    return;
                }
                
                // 2. Run Solution Query
                let solRes = [];
                try { solRes = db.exec(activeSnippet.solution); } catch(e) { console.error("Solution error:", e); }
                
                const userRows = userRes.length ? userRes[0].values : [];
                const solRows = solRes.length ? solRes[0].values : [];
                
                // 3. Compare (Basic: check row count and content)
                // We stringify to check for exact match of values and order
                // Ideally we should sort them if order doesn't matter, but for teaching SQL, usually order matters or is specified.
                const isCorrect = JSON.stringify(userRows) === JSON.stringify(solRows);
                
                runQuery(); // Always run to show results

                if (isCorrect) {
                    // Save Progress
                    if (!completedLessons.includes(activeSnippet.title)) {
                        completedLessons.push(activeSnippet.title);
                        localStorage.setItem('sql_buddy_progress', JSON.stringify(completedLessons));
                        renderSidebar();
                    }
                    
                    // Visual Feedback in Banner
                    const originalBorder = banner.style.borderColor;
                    banner.classList.remove('border-slate-700');
                    banner.classList.add('bg-green-900/20', 'border-green-500/50');
                    
                    // Visual Feedback in Results
                    const successMsg = document.createElement('div');
                    successMsg.className = "bg-green-100 text-green-800 p-2 text-xs font-bold text-center border-b border-green-200 transition-opacity duration-500";
                    successMsg.innerHTML = "✅ Correct! Result matches the solution.";
                    resultContainer.insertBefore(successMsg, resultContainer.firstChild);
                    
                    setTimeout(() => {
                        successMsg.classList.add('opacity-0');
                        setTimeout(() => successMsg.remove(), 500);
                    }, 3000);

                    setTimeout(() => {
                        banner.classList.remove('bg-green-900/20', 'border-green-500/50');
                        banner.classList.add('border-slate-700');
                    }, 2000);

                    // Show Next Lesson Button
                    document.getElementById('btn-next').classList.remove('hidden');
                    document.getElementById('btn-check').classList.add('hidden');
                    
                } else {
                    // Failure Feedback
                    banner.classList.remove('border-slate-700');
                    banner.classList.add('bg-red-900/20', 'border-red-500/50');

                    const failMsg = document.createElement('div');
                    failMsg.className = "bg-red-100 text-red-800 p-2 text-xs font-bold text-center border-b border-red-200 transition-opacity duration-500";
                    failMsg.innerHTML = "❌ Incorrect. Results do not match solution.";
                    resultContainer.insertBefore(failMsg, resultContainer.firstChild);

                    setTimeout(() => {
                        failMsg.classList.add('opacity-0');
                        setTimeout(() => failMsg.remove(), 500);
                    }, 3000);

                     setTimeout(() => {
                        banner.classList.remove('bg-red-900/20', 'border-red-500/50');
                        banner.classList.add('border-slate-700');
                    }, 2000);
                }

            } catch (err) {
                console.error(err);
            }
        }

        function loadPreviousLesson() {
             // Find current lesson index
            let currentCatIdx = -1;
            let currentLessonIdx = -1;

            for (let i = 0; i < CURRICULUM.length; i++) {
                const lIdx = CURRICULUM[i].lessons.findIndex(l => l.title === activeSnippet.title);
                if (lIdx !== -1) {
                    currentCatIdx = i;
                    currentLessonIdx = lIdx;
                    break;
                }
            }

            if (currentCatIdx === -1) return; // Not found

            if (currentLessonIdx > 0) {
                // Previous in same category
                loadLesson(CURRICULUM[currentCatIdx].lessons[currentLessonIdx - 1]);
            } else if (currentCatIdx > 0) {
                // Last in previous category
                const prevCat = CURRICULUM[currentCatIdx - 1];
                loadLesson(prevCat.lessons[prevCat.lessons.length - 1]);
            } else {
                // Already at the start
                alert("This is the first lesson.");
            }
        }

        function loadNextLesson() {
            // Find current lesson index
            let currentCatIdx = -1;
            let currentLessonIdx = -1;

            for (let i = 0; i < CURRICULUM.length; i++) {
                const lIdx = CURRICULUM[i].lessons.findIndex(l => l.title === activeSnippet.title);
                if (lIdx !== -1) {
                    currentCatIdx = i;
                    currentLessonIdx = lIdx;
                    break;
                }
            }

            if (currentCatIdx === -1) return; // Not found

            // Calculate next
            if (currentLessonIdx < CURRICULUM[currentCatIdx].lessons.length - 1) {
                // Next in same category
                loadLesson(CURRICULUM[currentCatIdx].lessons[currentLessonIdx + 1]);
            } else if (currentCatIdx < CURRICULUM.length - 1) {
                // First in next category
                loadLesson(CURRICULUM[currentCatIdx + 1].lessons[0]);
            } else {
                alert("Congratulations! You have completed all lessons!");
            }
        }

        // --- RENDERING ---
        function renderSidebar() {
            // Render Curriculum
            const currContainer = document.getElementById('curriculum-list');
            currContainer.innerHTML = CURRICULUM.map((cat, i) => `
                <div class="mb-2">
                    <button onclick="toggleCategory(${i})" class="flex items-center justify-between w-full px-2 py-1 text-slate-400 font-bold text-xs hover:text-slate-200 transition-colors group">
                        <span class="group-hover:text-white transition-colors">${cat.category}</span>
                        <i data-lucide="chevron-down" class="w-3 h-3 transition-transform duration-200" id="cat-icon-${i}"></i>
                    </button>
                    <div id="cat-content-${i}" class="overflow-hidden transition-all duration-300">
                        ${cat.lessons.map((lesson, j) => {
                            const isCompleted = completedLessons.includes(lesson.title);
                            const checkIcon = isCompleted 
                                ? '<i data-lucide="check-circle-2" class="w-3.5 h-3.5 text-green-500"></i>' 
                                : '<div class="w-1.5 h-1.5 rounded-full bg-slate-600 ml-1 mr-1"></div>';
                            
                            return `
                            <button onclick="loadLesson(CURRICULUM[${i}].lessons[${j}])" class="sidebar-item ml-2 border-l border-slate-800 pl-2">
                               ${checkIcon}
                               <span class="${isCompleted ? 'text-slate-300' : ''}">${lesson.title}</span>
                            </button>
                        `}).join('')}
                    </div>
                </div>
            `).join('');

            // Render User Snippets
            const snipContainer = document.getElementById('snippet-list');
            if (savedSnippets.length === 0) {
                snipContainer.innerHTML = '<div class="text-xs text-slate-600 italic px-3">No saved snippets</div>';
            } else {
                snipContainer.innerHTML = savedSnippets.map(s => `
                    <div class="flex items-center justify-between group hover:bg-slate-800 rounded pr-2">
                        <button onclick="loadSnippet('${s.id}')" class="flex-1 text-left text-sm px-3 py-1.5 text-slate-300 truncate">
                            ${s.title || 'Untitled'}
                        </button>
                        <button onclick="deleteSnippet('${s.id}')" class="text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                            <i data-lucide="trash-2" class="w-3 h-3"></i>
                        </button>
                    </div>
                `).join('');
            }

            // Render Schema with Keys
            const schemaContainer = document.getElementById('schema-container');
            schemaContainer.innerHTML = Object.keys(SCHEMA).map(table => `
                <div class="bg-slate-800/50 border border-slate-700 rounded mb-2 overflow-hidden">
                    <button onclick="showTableDetails('${table}')" class="w-full px-3 py-1 bg-slate-800 text-xs font-bold text-emerald-400 font-mono flex items-center justify-between gap-2 hover:bg-slate-700 hover:text-white transition-colors cursor-pointer group">
                        <div class="flex items-center gap-2">
                            <i data-lucide="table" class="w-3 h-3"></i>
                            ${table}
                        </div>
                        <i data-lucide="info" class="w-3 h-3 opacity-0 group-hover:opacity-100 text-slate-400"></i>
                    </button>
                    <div class="p-2 space-y-1">
                        ${Object.keys(SCHEMA[table]).map(col => {
                            const info = SCHEMA[table][col];
                            let icon = '';
                            let colClass = 'text-slate-400';
                            if (info.key === 'PK') {
                                icon = '<i data-lucide="key" class="w-3 h-3 text-amber-400 mr-1"></i>';
                                colClass = 'text-amber-100 font-bold';
                            } else if (info.key === 'FK') {
                                icon = '<i data-lucide="link" class="w-3 h-3 text-blue-400 mr-1"></i>';
                                colClass = 'text-blue-200';
                            } else {
                                icon = '<div class="w-4"></div>';
                            }

                            return `
                            <div class="flex justify-between items-center text-[10px] font-mono group hover:bg-slate-800/50 rounded px-1 -mx-1">
                                <div class="flex items-center">
                                    ${icon}
                                    <span class="${colClass}">${col}</span>
                                </div>
                                <span class="text-slate-600 italic">${info.type.substring(0,3)}</span>
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `).join('');

            lucide.createIcons();
        }

        function toggleCategory(i) {
             const content = document.getElementById(`cat-content-${i}`);
             const icon = document.getElementById(`cat-icon-${i}`);
             content.classList.toggle('hidden');
             icon.style.transform = content.classList.contains('hidden') ? 'rotate(-90deg)' : 'rotate(0deg)';
        }

        // --- LOGIC ---

        function loadLesson(lesson) {
            // Creating a "temp" snippet for the lesson
            activeSnippet = {
                id: null, // null ID means it's not saved yet
                title: lesson.title,
                sql: "", // Empty for them to type
                task: lesson.task,
                solution: lesson.solution,
                reqKeywords: lesson.reqKeywords,
                explanation: lesson.explanation
            };
            updateUI();
        }

        function loadSnippet(id) {
            const found = savedSnippets.find(s => s.id === id);
            if (found) {
                activeSnippet = { ...found, task: null, solution: null, explanation: null, reqKeywords: null }; // Load simplified
                updateUI();
                runQuery(); // Auto run on load
            }
        }

        function createNewSnippet() {
            activeSnippet = {
                id: Date.now().toString(),
                title: "New Query",
                sql: "SELECT * FROM users",
                task: null,
                solution: null,
                reqKeywords: null,
                explanation: null
            };
            savedSnippets.push(activeSnippet);
            saveToStorage();
            updateUI();
            runQuery();
        }

        function updateUI() {
            document.getElementById('snippet-title').value = activeSnippet.title;
            document.getElementById('sql-editor').value = activeSnippet.sql;
            
            // Task Banner
            const banner = document.getElementById('task-banner');
            const btnNext = document.getElementById('btn-next');
            const btnCheck = document.getElementById('btn-check');

            if (activeSnippet.task) {
                banner.classList.remove('hidden');
                document.getElementById('task-text').innerText = activeSnippet.task;
                
                // Reset buttons state on new lesson
                if(btnNext) btnNext.classList.add('hidden');
                if(btnCheck) btnCheck.classList.remove('hidden');
                
                // Explanation
                const expBox = document.getElementById('explanation-box');
                if (activeSnippet.explanation) {
                    expBox.classList.remove('hidden');
                    document.getElementById('explanation-text').innerHTML = activeSnippet.explanation;
                } else {
                    expBox.classList.add('hidden');
                }

                document.getElementById('solution-code').innerText = activeSnippet.solution;
                document.getElementById('solution-box').classList.add('hidden');
                document.getElementById('solution-btn-text').innerText = "Solution";
            } else {
                banner.classList.add('hidden');
            }
        }

        function runQuery() {
            const sql = document.getElementById('sql-editor').value;
            const errorContainer = document.getElementById('error-container');
            const resultContainer = document.getElementById('result-container');
            const rowCount = document.getElementById('row-count');
            
            // Visual feedback (Run Flash)
            const rightPanel = resultContainer.parentElement;
            const flash = document.createElement('div');
            flash.className = 'absolute inset-0 bg-green-500/10 pointer-events-none z-10 transition-opacity duration-300';
            rightPanel.appendChild(flash);
            setTimeout(() => flash.classList.add('opacity-0'), 50);
            setTimeout(() => flash.remove(), 350);

            try {
                // If query is empty do nothing
                if (!sql.trim()) return;

                const res = db.exec(sql);
                errorContainer.classList.add('hidden');
                
                if (res.length === 0) {
                    // Check if it was a modification query
                    if (sql.toLowerCase().includes('insert') || sql.toLowerCase().includes('update')) {
                         resultContainer.innerHTML = '<div class="h-full flex flex-col items-center justify-center text-slate-500 gap-2"><i data-lucide="check-circle-2" class="w-10 h-10 text-green-500/50"></i><p>Query executed successfully.</p></div>';
                         lucide.createIcons();
                    } else {
                         resultContainer.innerHTML = '<div class="h-full flex items-center justify-center text-slate-500 italic">Query executed. No rows returned.</div>';
                    }
                    rowCount.innerText = "0 rows";
                    return;
                }

                const data = res[0];
                rowCount.innerText = `${data.values.length} rows`;

                // Render Table
                let html = '<table class="results-table"><thead class="results-thead"><tr>';
                data.columns.forEach(col => html += `<th class="results-th">${col}</th>`);
                html += '</tr></thead><tbody>';
                data.values.forEach(row => {
                    html += '<tr class="results-tr">';
                    row.forEach(val => html += `<td class="results-td">${val}</td>`);
                    html += '</tr>';
                });
                html += '</tbody></table>';
                resultContainer.innerHTML = html;

            } catch (err) {
                errorContainer.classList.remove('hidden');
                let msg = err.message;
                let hint = "";

                // Friendly Error Hints
                if (msg.includes("no such table")) {
                    hint = "Did you misspell the table name? Check the Schema list on the left.";
                } else if (msg.includes("no such column")) {
                    hint = "That column doesn't exist. Check the spelling or the Schema.";
                } else if (msg.includes("syntax error")) {
                    hint = "Check your SQL syntax. Are you missing a keyword like FROM or WHERE?";
                } else if (msg.includes("ambiguous column name")) {
                    hint = "Two joined tables have this column. Use 'table_name.column_name' to be specific.";
                }

                if (hint) {
                    msg += `<br><br><span class="text-slate-500 font-normal">💡 <strong>Hint:</strong> ${hint}</span>`;
                }

                document.getElementById('error-message').innerHTML = msg;
            }
        }

        // --- STORAGE & UTILS ---
        let saveTimer;
        function debounceSave() {
            clearTimeout(saveTimer);
            saveTimer = setTimeout(() => {
                // If it's a saved snippet (has ID), update it
                if (activeSnippet.id) {
                    const idx = savedSnippets.findIndex(s => s.id === activeSnippet.id);
                    if (idx !== -1) savedSnippets[idx] = { ...activeSnippet };
                    saveToStorage();
                    document.getElementById('save-status').classList.remove('hidden');
                    setTimeout(() => document.getElementById('save-status').classList.add('hidden'), 2000);
                }
            }, 1000);
        }

        function saveToStorage() {
            localStorage.setItem('sql_buddy_snippets', JSON.stringify(savedSnippets));
            renderSidebar();
        }

        function deleteSnippet(id) {
            if (confirm("Delete this snippet?")) {
                savedSnippets = savedSnippets.filter(s => s.id !== id);
                saveToStorage();
                if (activeSnippet.id === id) loadLesson(CURRICULUM[0].lessons[0]);
            }
        }

        function toggleSolution() {
            const box = document.getElementById('solution-box');
            const btnText = document.getElementById('solution-btn-text');
            if (box.classList.contains('hidden')) {
                box.classList.remove('hidden');
                btnText.innerText = "Hide Solution";
            } else {
                box.classList.add('hidden');
                btnText.innerText = "Show Solution";
            }
        }
    </script>
</body>
</html>
